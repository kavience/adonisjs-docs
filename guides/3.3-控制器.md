# æ§åˆ¶å™¨
æ§åˆ¶å™¨æ˜¯ AdonisJS ä¸­å¤„ç† HTTP è¯·æ±‚çš„å®é™…æ–¹å¼ã€‚å®ƒä»¬ä½¿ä½ èƒ½å¤Ÿé€šè¿‡å°†æ‰€æœ‰å†…è”è·¯ç”±å¤„ç†ç¨‹åºç§»åŠ¨åˆ°å…¶ä¸“ç”¨æ§åˆ¶å™¨æ–‡ä»¶ã€‚

åœ¨ AdonisJS ä¸­ï¼Œæ§åˆ¶å™¨å­˜å‚¨åœ¨ï¼ˆä½†ä¸é™äºï¼‰ **app/Controllers/Http** ç›®å½•ä¸­ï¼Œæ¯ä¸ªæ–‡ä»¶ä»£è¡¨ä¸€ä¸ªæ§åˆ¶å™¨ã€‚ä¾‹å¦‚ï¼š

```ts
import { HttpContextContract } from '@ioc:Adonis/Core/HttpContext'

export default class PostsController {
  public async index(ctx: HttpContextContract) {
    return [
      {
        id: 1,
        title: 'Hello world',
      },
      {
        id: 2,
        title: 'Hello universe',
      },
    ]
  }
}
```

ä½ å¿…é¡»åœ¨ **start/routes.ts** æ–‡ä»¶ä¸­å°†å…¶ä½œä¸ºè·¯ç”±å¤„ç†ç¨‹åºå¼•ç”¨æ‰èƒ½ä½¿ç”¨æ­¤æ§åˆ¶å™¨ã€‚

```ts
Route.get('posts', 'PostsController.index')
```

## æ§åˆ¶å™¨ä½ç½®

æŒ‰ç…§æƒ¯ä¾‹ï¼Œæ§åˆ¶å™¨å­˜å‚¨åœ¨ **app/Controllers/Http** ç›®å½•ä¸­ï¼Œä½†è¿™ä¸æ˜¯ç¡¬æ€§è§„å®šï¼Œä½ å¯ä»¥åœ¨ **.adonisrc.json** æ–‡ä»¶ä¸­ä¿®æ”¹å®ƒä»¬çš„ä½ç½®ã€‚

```json
{
  "namespaces": {
    "httpControllers": "App/Controllers"
  }
}
```

ç°åœ¨ï¼ŒAdonisJS å°†åœ¨ **App/Controllers** ç›®å½•ä¸­æ‰¾åˆ°æ§åˆ¶å™¨ã€‚æ­¤å¤–ï¼Œ **make:controller** å‘½ä»¤å°†åœ¨æ­£ç¡®çš„ä½ç½®åˆ›å»ºå®ƒä»¬ã€‚

> ä½ çš„æ§åˆ¶å™¨ä¸éœ€è¦åªåœ¨ä¸€ä¸ªç›®å½•ä¸­ã€‚ä½ å¯ä»¥åœ¨åº”ç”¨ç¨‹åºç»“æ„ä¸­è‡ªç”±ç§»åŠ¨å®ƒä»¬ã€‚ç¡®ä¿åœ¨ä½ çš„è·¯ç”±å£°æ˜ä¸­æ­£ç¡®å¼•å…¥å®ƒä»¬ã€‚

### è·¯ç”±å‘½åç©ºé—´
å½“æ§åˆ¶å™¨æœ‰ä¸åŒçš„ä½ç½®æ—¶ï¼Œä½¿ç”¨è·¯ç”±ç»„å®šä¹‰æ§åˆ¶å™¨çš„å‘½åç©ºé—´å¯èƒ½ä¼šå¾ˆæ–¹ä¾¿ã€‚

```ts
Route.group(() => {
  Route.get('cart', 'CartController.index')
  Route.put('cart', 'CartController.update')
}).namespace('App/Modules/Checkout')
```

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œå°†ä» **App/Modules/Checkout** å¼•å…¥ **CartController** ã€‚

> å‘½åç©ºé—´åº”è¯¥æ˜¯åº”ç”¨ç¨‹åºæ ¹ç›®å½•çš„ç»å¯¹è·¯å¾„ã€‚

## é€šè¿‡å‘½ä»¤åˆ›å»ºæ§åˆ¶å™¨
ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ **node ace** å‘½ä»¤æ¥åˆ›å»ºæ–°æ§åˆ¶å™¨ã€‚

```sh
node ace make:controller Post

# CREATE: app/Controllers/Http/PostsController.ts
```

å¦‚æœä½ æ³¨æ„åˆ°ï¼Œåœ¨ä¸Šé¢çš„å‘½ä»¤ä¸­ï¼Œæˆ‘ä»¬æåˆ°äº† Post è¿™ä¸ªè¯æ˜¯å•æ•°çš„ï¼Œè€Œç”Ÿæˆçš„æ–‡ä»¶åæ˜¯å¤æ•°å½¢å¼å¹¶ä¸”æœ‰ä¸€ä¸ª **Controller** åç¼€ã€‚

AdonisJS åº”ç”¨è¿™äº›è½¬æ¢æ¥ç¡®ä¿æ–‡ä»¶ååœ¨æ•´ä¸ªé¡¹ç›®ä¸­ä¿æŒä¸€è‡´ã€‚ä½†æ˜¯ï¼Œä½ å¯ä»¥ä½¿ç”¨ **--exact** æ ‡å¿—æŒ‡ç¤º CLI ä¸è¦åº”ç”¨è¿™äº›è½¬æ¢ã€‚

![](https://res.cloudinary.com/adonis-js/image/upload/f_auto,q_auto/v1611555570/v5/controller-help-exact-flag.png)

## æ§åˆ¶å™¨è·¯ç”±å¼•ç”¨
å¦‚ä½ æ‰€è§ï¼Œæ§åˆ¶å™¨åœ¨è·¯ç”±ä¸Šä½œä¸ºå­—ç¬¦ä¸²è¡¨è¾¾å¼å¼•ç”¨ï¼Œå³ "Controller.method" ã€‚æˆ‘ä»¬æœ‰æ„é€‰æ‹©è¿™ç§æ–¹æ³•æ¥æ”¯æŒå»¶è¿ŸåŠ è½½æ§åˆ¶å™¨å’Œä¸å¤ªå†—é•¿çš„è¯­æ³•ã€‚

å¦‚æœæˆ‘ä»¬å†³å®šä¸ä½¿ç”¨å­—ç¬¦ä¸²è¡¨è¾¾å¼ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹è·¯ç”±æ–‡ä»¶çš„å¤–è§‚ã€‚

```ts
import Route from '@ioc:Adonis/Core/Route'
import PostsController from 'App/Controllers/Http/PostsController'

Route.get('/posts', async (ctx) => {
  return new PostsController().index(ctx)
})
```

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åœ¨è·¯ç”±æ–‡ä»¶ä¸­å¼•å…¥ PostsController ã€‚ç„¶åï¼Œåˆ›å»ºä¸€ä¸ªå®ä¾‹å¹¶è¿è¡Œ index æ–¹æ³•ï¼Œä¼ é€’ ctx å¯¹è±¡ã€‚

ç°åœ¨æƒ³è±¡ä¸€ä¸ªå…·æœ‰ 40-50 ä¸ªä¸åŒæ§åˆ¶å™¨çš„åº”ç”¨ç¨‹åºã€‚æ¯ä¸ªæ§åˆ¶å™¨éƒ½æœ‰è‡ªå·±çš„ä¸€ç»„å¼•å…¥ï¼Œæ‰€æœ‰è¿™äº›éƒ½è¢«æ‹‰åˆ°ä¸€ä¸ªå•ç‹¬çš„è·¯ç”±æ–‡ä»¶ä¸­ï¼Œä½¿è·¯ç”±æ–‡ä»¶æˆä¸ºä¸€ä¸ªé˜»å¡ç‚¹ã€‚

### æ‡’åŠ è½½
å»¶è¿ŸåŠ è½½æ§åˆ¶å™¨æ˜¯ä¸Šè¿°é—®é¢˜çš„å®Œç¾è§£å†³æ–¹æ¡ˆã€‚æ— éœ€åœ¨é¡¶å±‚å¼•å…¥æ‰€æœ‰å†…å®¹ã€‚ç›¸åï¼Œæ ¹æ®éœ€è¦å¼•å…¥æ§åˆ¶å™¨ã€‚

```ts
import Route from '@ioc:Adonis/Core/Route'

Route.get('/posts', async (ctx) => {
  const { default: PostsController } = await import(
    'App/Controllers/Http/PostsController'
  )
  return new PostsController().index(ctx)
})
```

æ‰‹åŠ¨å¼•å…¥æ§åˆ¶å™¨ï¼Œå®ä¾‹åŒ–ç±»ä»ç„¶æ˜¯å¤ªå¤šçš„ä»£ç ï¼Œå› ä¸ºåº”ç”¨ç¨‹åºå¯èƒ½è¶…è¿‡ 100 ä¸ªè·¯ç”±ã€‚

### æŠ¼æ³¨ TypeScript çš„æœªæ¥
åŸºäºå­—ç¬¦ä¸²çš„å¼•ç”¨æä¾›äº†ä¸¤å…¨å…¶ç¾çš„ä¼˜åŠ¿ã€‚æ§åˆ¶å™¨æ˜¯å»¶è¿ŸåŠ è½½çš„ï¼Œè¯­æ³•ç®€æ´ã€‚

ä½†æ˜¯ï¼Œå®ƒæ˜¯ç±»å‹ä¸å®‰å…¨çš„ã€‚å¦‚æœæ§åˆ¶å™¨æˆ–æ–¹æ³•ä¸å­˜åœ¨ï¼ŒIDE ä¸ä¼šæç¤ºæŠ¥é”™ã€‚

ä»å¥½çš„æ–¹é¢æ¥è¯´ï¼Œä½¿å­—ç¬¦ä¸²è¡¨è¾¾å¼ç±»å‹å®‰å…¨å¹¶éä¸å¯èƒ½ã€‚TypeScript å·²ç»åœ¨æœç€è¿™ä¸ªæ–¹å‘å–å¾—è¿›å±•ã€‚åœ¨å¼•ç”¨ "Controller.method" å­—ç¬¦ä¸²è¡¨è¾¾å¼æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä¸¤ä»¶äº‹æ¥å®ç°ç±»å‹å®‰å…¨ã€‚

- æ ‡è®°å­—ç¬¦ä¸²è¡¨è¾¾å¼å¹¶åˆ›å»ºæ§åˆ¶å™¨åŠå…¶æ–¹æ³•çš„å®Œæ•´è·¯å¾„çš„èƒ½åŠ›ã€‚å®ƒå¯ä»¥é€šè¿‡ TypeScript 4.1 åŠæ›´é«˜ç‰ˆæœ¬å®ç°ã€‚ä¾‹å¦‚ï¼Œ[è¿™é‡Œ](https://www.typescriptlang.org/play?ts=4.1.3#code/MYewdgzgLgBASiArlApjAvDA3gKBjAcxSgB4AJAQzABMAbFAJxhQA9UaIZoGBLMAgHwAKAA4UoqBmABcXKL34AaGAAsqdRrMo16DAJSyY2jU1btqnAAYASLHwBmjGAEEAvgDpbDpwCFXlmAB+bDx8GFAweRBaXVlLZxERAHoAYXAomMYIJLIJZNs3S0VQ-ABbYhUQalkfUNcYWUQwAGswEAB3MBxXHF6kpKMQADcnYacoFTQAIgYkVCmYIYpeCgAjehh1LhQ0CfEYdrRlo-XdkBgxBggjuQUCGD4oc6fmlEgcCOgYWeQ0TARfu4iFAhAByJKg5SgsggcppSKzTIMdx8aisUF6IA)æ˜¯ç›¸åŒçš„æ¦‚å¿µè¯æ˜ã€‚
- æ¥ä¸‹æ¥æ˜¯æ‹¥æœ‰æ”¯æŒæ³›å‹çš„ Import ç±»å‹çš„èƒ½åŠ›ã€‚æœ‰ä¸€ä¸ª[æœªè§£å†³çš„é—®é¢˜](https://github.com/microsoft/TypeScript/issues/31090)ï¼Œæˆ‘ä»¬ä¹è§‚åœ°è®¤ä¸ºå®ƒä¼šåœ¨æœªæ¥è¿›å…¥ TypeScriptï¼Œå› ä¸ºå®ƒç¬¦åˆ TypeScript çš„è®¾è®¡ç›®æ ‡ã€‚


## CRUD æ“ä½œ
REST çš„åŸåˆ™æä¾›äº†ä¸€ç§å¾ˆå¥½çš„æ–¹å¼æ¥æ˜ å°„ CRUD æ“ä½œå’Œ HTTP æ–¹æ³•ï¼Œè€Œä¸ä¼šä½¿ URL å˜å¾—å†—é•¿ã€‚

ä¾‹å¦‚ï¼Œ URL /posts å¯ç”¨äºæŸ¥çœ‹æ‰€æœ‰å¸–å­å¹¶åˆ›å»ºæ–°å¸–å­ï¼Œåªéœ€ä½¿ç”¨æ­£ç¡®çš„ HTTP æ–¹æ³•å³å¯ã€‚

```ts
Route.get('/posts', () => {
  return 'List of posts'
})

// ğŸ‘‡
Route.post('/posts', () => {
  return 'Create a new post'
})
```
è¿™æ˜¯æ‰§è¡Œ CRUD æ“ä½œçš„æ‰€æœ‰è·¯ç”±çš„åˆ—è¡¨ã€‚
```ts
Route.get('/posts', () => {
  return 'List all posts'
})

Route.get('/posts/create', () => {
  return 'Display a form to create a post'
})

Route.post('/posts', async () => {
  return 'Handle post creation form request'
})

Route.get('/posts/:id', () => {
  return 'Return a single post'
})

Route.get('/posts/:id/edit', () => {
  return 'Display a form to edit a post'
})

Route.put('/posts/:id', () => {
  return 'Handle post update form submission'
})

Route.delete('/posts/:id', () => {
  return 'Delete post'
})
```

## èµ„æºå‹çš„è·¯ç”±å’Œæ§åˆ¶å™¨
ç”±äºä¸Šè¿°è·¯ç”±ä½¿ç”¨çš„æ˜¯é¢„å®šä¹‰çš„çº¦å®šã€‚ AdonisJS æä¾›äº†ä¸€ç§ä½¿ç”¨ **Route.resource** æ–¹æ³•å°†æ‰€æœ‰è·¯ç”±æ³¨å†Œåœ¨ä¸€èµ·çš„å¿«æ·æ–¹å¼ã€‚

```ts
Route.resource('posts', 'PostsController')
```

ä»¥ä¸‹æ˜¯å·²æ³¨å†Œè·¯ç”±çš„åˆ—è¡¨ã€‚
![](https://res.cloudinary.com/adonis-js/image/upload/q_auto,f_auto/v1611651446/v5/routes-list.png)

### å‘½åè·¯ç”±
å¦‚ä½ æ‰€è§ï¼Œèµ„æºæ³¨å†Œçš„æ¯æ¡è·¯ç”±éƒ½æœ‰ä¸€ä¸ªåç§°ã€‚è·¯ç”±åç§°æ˜¯é€šè¿‡ç»„åˆèµ„æºåç§°å’Œè·¯ç”±æ‰§è¡Œçš„æ“ä½œæ¥åˆ›å»ºçš„ã€‚ä¾‹å¦‚ï¼š

- **posts.create** è¡¨ç¤ºæ˜¾ç¤ºè¡¨å•ä»¥åˆ›å»ºæ–°å¸–å­çš„è·¯ç”±
- **posts.store** è¡¨ç¤ºåˆ›å»ºæ–°å¸–å­çš„è·¯ç”±ï¼Œä¾æ­¤ç±»æ¨ã€‚

ä½¿ç”¨ **.as** æ–¹æ³•ï¼Œä½ å¯ä»¥æ›´æ”¹æ“ä½œåç§°ä¹‹å‰çš„å‰ç¼€ã€‚

```ts
Route.resource('posts', 'PostsController').as('articles')
```

```
articles.index
articles.create
articles.store
articles.show
articles.edit
articles.update
articles.destroy
```

### è¿‡æ»¤è·¯ç”±
åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œä½ ä¼šå¸Œæœ›é˜»æ­¢æŸäº›èµ„æºå‹çš„è·¯ç”±æ³¨å†Œã€‚ä¾‹å¦‚ï¼Œä½ å†³å®šé™åˆ¶åšå®¢ç”¨æˆ·æ›´æ–°æˆ–åˆ é™¤ä»–ä»¬çš„è¯„è®ºï¼Œå› æ­¤ä¸éœ€è¦ç›¸åŒçš„è·¯ç”±ã€‚

```ts
Route
  .resource('comments', 'CommentsController')
  .except(['update', 'destroy']) // ğŸ‘ˆ
```

ä¸ except æ–¹æ³•ç›¸åçš„æ˜¯å”¯ä¸€æ–¹æ³•ã€‚å®ƒåªæ³¨å†Œå…·æœ‰ç»™å®šåŠ¨ä½œåç§°çš„è·¯ç”±ã€‚

```ts
Route
  .resource('comments', 'CommentsController')
  .only(['index', 'show', 'store']) // ğŸ‘ˆ
```

### é’ˆå¯¹ api çš„è·¯ç”±
åˆ›å»º API æœåŠ¡å™¨æ—¶ï¼Œæ˜¾ç¤ºè¡¨å•çš„è·¯ç”±æ˜¯å¤šä½™çš„ï¼Œå› ä¸ºä½ å°†åœ¨å‰ç«¯æˆ–ç§»åŠ¨åº”ç”¨ç¨‹åºä¸­åˆ¶ä½œè¿™äº›è¡¨å•ã€‚ä½ å¯ä»¥é€šè¿‡è°ƒç”¨ apiOnly æ–¹æ³•æ¥åˆ é™¤è¿™äº›è·¯ç”±ã€‚

```ts
Route.resource('posts', 'PostsController').apiOnly() // ğŸ‘ˆ
```

### ä½¿ç”¨ä¸­é—´ä»¶
**.middleware** æ–¹æ³•è¿˜å°†ä¸­é—´ä»¶åº”ç”¨äºç»™å®šèµ„æºæ³¨å†Œçš„æ‰€æœ‰æˆ–é€‰å®šçš„è·¯ç”±é›†ã€‚

```ts
Route.resource('users', 'UsersController').middleware({
  '*': ['auth'],
})
```

æˆ–è€…ä»…å°†ä¸­é—´ä»¶åº”ç”¨äºé€‰å®šçš„æ“ä½œã€‚åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œå¯¹è±¡é”®å¿…é¡»æ˜¯æ“ä½œåç§°ã€‚

```ts
Route.resource('users', 'UsersController').middleware({
  create: ['auth'],
  store: ['auth'],
  destroy: ['auth'],
})
```

## èµ„æºåµŒå¥—
ä½ è¿˜å¯ä»¥é€šè¿‡ä½¿ç”¨ç‚¹ç¬¦å· (.) åˆ†éš”æ¯ä¸ªèµ„æºæ¥æ³¨å†ŒåµŒå¥—èµ„æºã€‚ä¾‹å¦‚ï¼š

```ts
Route.resource('posts.comments', 'CommentsController')
```
![](https://res.cloudinary.com/adonis-js/image/upload/q_auto,f_auto/v1611673295/v5/nested-resource.png)

å¦‚ä½ æ‰€è§ï¼Œçˆ¶èµ„æº ID ä»¥èµ„æºåç§°ä¸ºå‰ç¼€ã€‚å³ post_id ã€‚

## æµ…å±‚èµ„æº
åœ¨åµŒå¥—èµ„æºä¸­ï¼Œæ¯ä¸ªå­èµ„æºéƒ½ä»¥çˆ¶èµ„æºåç§°åŠå…¶ ID ä¸ºå‰ç¼€ã€‚ä¾‹å¦‚ï¼š

- /posts/:post_id/commentsï¼šæŸ¥çœ‹å¸–å­çš„æ‰€æœ‰è¯„è®º
- /posts/:post_id/comments/:idï¼šæŒ‰ id æŸ¥çœ‹æ‰€æœ‰è¯„è®ºã€‚

:post_id åœ¨ç¬¬äºŒæ¡è·¯ç”±ä¸­çš„å­˜åœ¨æ˜¯æ— å…³ç´§è¦çš„ï¼Œå› ä¸ºä½ å¯ä»¥ç›´æ¥é€šè¿‡å…¶ id æŸ¥æ‰¾è¯„è®ºã€‚

ä¸ºäº†ä¿æŒ URL ç»“æ„å¹³å¦ï¼ˆå°½å¯èƒ½ï¼‰ï¼Œä½ å¯ä»¥ä½¿ç”¨æµ…å±‚èµ„æºã€‚

```ts
Route.shallowResource('posts.comments', 'CommentsController')
```

![](https://res.cloudinary.com/adonis-js/image/upload/q_auto,f_auto/v1612004976/v5/shallow-resource.png)

## é‡å¤ä½¿ç”¨æ§åˆ¶å™¨

è®¸å¤šå¼€å‘äººå‘˜å€¾å‘äºé€šè¿‡å°†æ§åˆ¶å™¨å¼•å…¥å…¶ä»–æ§åˆ¶å™¨æ¥å°è¯•é‡ç”¨æ§åˆ¶å™¨çš„é”™è¯¯ã€‚

å¦‚æœä½ æƒ³åœ¨åº”ç”¨ç¨‹åºä¸­é‡ç”¨æŸäº›é€»è¾‘ï¼Œåˆ™å¿…é¡»å°†è¯¥æ®µä»£ç æå–åˆ°å®ƒçš„ç±»æˆ–å¯¹è±¡ä¸­ï¼Œé€šå¸¸ç§°ä¸ºæœåŠ¡å¯¹è±¡ã€‚

æˆ‘ä»¬å¼ºçƒˆå»ºè®®å°†ä½ çš„æ§åˆ¶å™¨è§†ä¸ºæµé‡è·ƒç‚¹ï¼Œå…¶å·¥ä½œæ˜¯æ¥å— HTTP è¯·æ±‚ï¼Œå°†å·¥ä½œåˆ†é…ç»™åº”ç”¨ç¨‹åºçš„å…¶ä»–éƒ¨åˆ†ï¼Œå¹¶è¿”å›å“åº”ã€‚æ‰€æœ‰å¯é‡ç”¨çš„é€»è¾‘éƒ½å¿…é¡»å­˜åœ¨äºæ§åˆ¶å™¨ä¹‹å¤–ã€‚

